# 分层和合成机制：为什么CSS动画比JS高效

## 帧 VS 帧率
渲染流水线生成的每一副图片称为**一帧**，把渲染流水线每秒更新了多少帧称为**帧率**，比如滚动过程中1秒更新了60帧，那么帧率就是60Hz(或者60FPS)

## Chrome合成技术
- 分层
- 分块
- 合成

### 分层和合成
将素材分解为多个图层的操作称为**分层**，最后将这些图层合并到一起的操作称为**合成**  

在Chrome的渲染流水线中，**分层体现在生成布局树后**，渲染引擎会根据布局树的特点将其转换为层树(Layer Tree),层树是渲染流水线后续流程的基础结构  
层树中的每个节点都对应着一个图层，下一步的绘制阶段就依赖于层树中的节点  

绘制阶段是将绘制指令组合成一个列表  

有了绘制列表后，进入光栅化阶段，光栅化会按照绘制列表中的指令生成图片  

**合成操作是在合成线程上完成的，这也意味着在执行合成操作时，是不会影响到主线程执行的**。这就是为什么经常主线程卡住了，但是CSS动画依然能执行的原因

### 分块
合成线程会将每个图层分割为大小固定的图块，然后优先绘制靠近视口的图块，这样就可以大大加速页面的显示速度。  

**在首次合成图块的时候使用一个低分辨率的图片**，当正常比例的网页内容绘制完成后，再替换掉当前显示的低分辨率内容。

## 如何利用分层技术优化代码

使用**will-change**告诉渲染引擎你会对该元素做一些特效变换

```
.box {
will-change: transform, opacity;
}

```
这段代码就是提前告诉渲染引擎box元素将要做几何变换和透明度变换操作，这时候渲染引擎会将该元素单独实现一帧，等这些变换发生时，渲染引擎会通过合成线程直接去处理变换，这些变换并没有涉及到主线程，这样就大大提升了渲染的效率。**这也是CSS动画比JS动画高效的原因**
# 安全沙箱：页面和系统之间的隔离墙
- XSS攻击只是将恶意的JS脚本注入到页面中，虽然能窃取一些Cookie相关的数据，但是XSS无法对操作系统进行攻击
- 而通过浏览器漏洞进行的攻击是可以入侵到浏览器进程内部的，可以读取和修改浏览器进程内部的任意内容，还可以穿透浏览器，在用户的操作系统上悄悄地安装恶意软件、监听用户键盘输入信息以及读取用户硬盘上的文件内容。


## 安全视角下的多进程架构
![](img/多进程架构.png)  

浏览器被划分为**浏览器内核**和**渲染内核**两个核心模块  
- 浏览器内核由网络进程、浏览器主进程和GPU进程组成
- 渲染内核就是渲染进程  

网络资源通过浏览器内核下载，然后资源通过IPC交给渲染进程(浏览器内核和渲染进程之间都是通过IPC来通信的)。  
渲染进程对这些资源进行解析、绘制等操作，最终生成图片。然后将图片提交给浏览器内核模块，由浏览器内核模块负责显示。

## 安全沙箱
**将渲染进程和操作系统隔离的这道墙就是安全沙箱**。即使渲染进程由于存在漏洞被黑客攻击，但由于安全沙箱，黑客就获取不到渲染进程之外的任何操作权限。  

浏览器中的安全沙箱是利用操作系统提供的安全技术，让渲染进程在执行过程中无法访问或者修改操作系统中的数据，在渲染进程需要访问系统资源的时候，需要通过浏览器内核来实现，然后将访问的结果通过IPC转发给渲染进程  

安全沙箱最小的保护单位是进程。因为单进程浏览器需要频繁访问或者修改操作系统的数据，所以单进程浏览器是无法被安全沙箱保护的，而现代浏览器采用的多进程架构使得安全沙箱可以发挥作用

## 安全沙箱如何影响各个模块功能
![](img/模块功能.png)  

安全沙箱是如何影响各个模块的
### 1.持久存储
文件内容的读写都是在浏览器内核中完成的  
- 存储Cookie数据的读写。通常浏览器内核会维护一个存放所有Cookie的Cookie数据库，然后当渲染进程通过JS来获取CooKie时，渲染进程会通过IPC将读取CooKie的信息发送给浏览器内核，浏览器内核读取Cookie之后再将内容返回给渲染进程
- 一些缓存文件的读写也是由浏览器内核实现的，比如网络文件缓存的读取

### 2.网络访问
由于安全沙箱的保护，渲染进程内部不能直接访问网络，需要通过浏览器内核。同时浏览器内核会检查渲染进程是否有权限访问该URL.

### 3.用户交互
由于安全沙箱，渲染进程不能直接访问**窗口句柄**(HWND和X Window),需要完成以下改变  
- 渲染进程需要渲染出位图。渲染进程会将生成的位图发送给浏览器内核显示到屏幕上  
- 操作系统没有将用户输入事件传递给渲染进程，而是将这些事件传递给浏览器内核。让其判断如何调度这些事件。

## 站点隔离(Site Isolation)
所谓站点隔离是指Chrome将同一站点(包含了相同根域名和相同协议的地址)中相关联的页面放到同一渲染进程中执行  
由于最初都是按照标签页来划分渲染进程的，所以如果一个标签页里面有多个不同源的iframe,那么这些iframe也会被分配到同一个渲染进程中，这样就很容易让黑客通过iframe来攻击当前渲染进程。  
而站点隔离会将不同源的iframe分配到不同的渲染进程中，这样即使黑客攻击恶意iframe的渲染进程，也不会影响到其他渲染进程。